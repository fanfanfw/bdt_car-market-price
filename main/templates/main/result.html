{% extends 'main/base.html' %}
{% load static %}

{% block title %}Hasil Estimasi Harga - Car Market Price{% endblock %}

{% block content %}
<!-- Header -->
<div class="text-center mb-8">
    <div class="flex justify-center items-center mb-4">
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-4 rounded-full shadow-lg">
            <i class="fas fa-check-circle text-3xl text-white"></i>
        </div>
    </div>
    <h1 class="text-4xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent mb-3">
        Hasil Estimasi Harga
    </h1>
    <p class="text-base-content/70 text-lg max-w-2xl mx-auto">
        Berikut adalah estimasi harga kendaraan Anda berdasarkan data pasar dan kondisi yang dipilih
    </p>
</div>

{% if phone_expired %}
<!-- Phone Verification Expired -->
<div class="alert alert-warning shadow-lg mb-8">
    <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-2xl"></i>
        <div>
            <h4 class="text-lg font-bold">Verifikasi Nomor Kedaluwarsa</h4>
            <p>Verifikasi nomor {{ phone_number }} sudah kedaluwarsa. Silakan verifikasi ulang.</p>
        </div>
    </div>
</div>

<div class="text-center">
    <a href="{% url 'main:index' %}" class="btn btn-primary">
        <i class="fas fa-arrow-left mr-2"></i>
        Kembali ke Form
    </a>
</div>

{% else %}
<!-- Loading and Results Container -->
<div class="card bg-base-100 shadow-2xl border-0 mb-8">
    <div class="card-body p-8">
        <!-- Car Info (Always visible) -->
        <div class="text-center pb-6 border-b border-base-200 mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6">
                <h2 class="text-2xl font-bold text-base-content mb-2">
                    {{ car_info }}
                </h2>
                <div class="flex justify-center items-center gap-4 text-base-content/70">
                    <span class="badge badge-outline badge-lg">
                        <i class="fas fa-calculator mr-1"></i>
                        Estimasi Harga
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
            <div class="loading loading-spinner loading-lg text-primary mb-4"></div>
            <p class="text-lg text-base-content/70">Memproses data kendaraan Anda...</p>
            <p class="text-sm text-base-content/50 mt-2">Harap tunggu, sedang memverifikasi nomor telepon</p>
        </div>
        
        <!-- Results Container (Hidden initially) -->
        <div id="resultsContainer" class="hidden">
            <!-- Results will be populated here via JavaScript -->
        </div>
        
        <!-- No Data State (Hidden initially) -->
        <div id="noDataState" class="hidden text-center py-8">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
                <div>
                    <h4 class="text-lg font-bold">Data Tidak Ditemukan</h4>
                    <p>Tidak ada data untuk kombinasi yang dipilih. Silakan coba kombinasi lain.</p>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'main:index' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Kembali ke Form
                </a>
            </div>
        </div>
        
        <!-- Error State (Hidden initially) -->
        <div id="errorState" class="hidden text-center py-8">
            <div class="alert alert-error">
                <i class="fas fa-times-circle text-2xl"></i>
                <div>
                    <h4 class="text-lg font-bold">Terjadi Kesalahan</h4>
                    <p id="errorMessage">Tidak dapat memproses data. Silakan coba lagi.</p>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'main:index' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Kembali ke Form
                </a>
            </div>
        </div>
        
        <!-- Actions (Hidden initially) -->
        <div id="resultActions" class="hidden flex flex-col sm:flex-row gap-4 justify-center mt-8">
            <a href="{% url 'main:index' %}" class="btn btn-primary">
                <i class="fas fa-calculator mr-2"></i>
                Hitung Estimasi Lain
            </a>
            <button onclick="window.print()" class="btn btn-outline btn-secondary">
                <i class="fas fa-print mr-2"></i>
                Cetak Hasil
            </button>
            <button onclick="shareResult()" class="btn btn-outline btn-accent">
                <i class="fas fa-share-alt mr-2"></i>
                Bagikan Hasil
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Global variables  
let phoneNumber = '{{ verified_phone|default:"" }}';
const phoneNotVerified = {{ phone_not_verified|yesno:"true,false" }};
const skipOTP = {{ skip_otp|yesno:"true,false" }};

// Auto-start verification process
document.addEventListener('DOMContentLoaded', function() {
    if (skipOTP && phoneNumber) {
        // Phone already verified, load results directly
        loadResults();
    } else if (phoneNotVerified) {
        // Phone needs verification, show OTP popup
        showOTPVerification();
    }
});

// Check phone status before asking for OTP
async function checkPhoneStatus(phoneNumber, countryCode) {
    try {
        const phoneOnly = phoneNumber.replace(countryCode, '');
        
        const response = await fetch('/api/check-phone/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phoneOnly,
                country_code: countryCode
            })
        });
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error checking phone status:', error);
        return { verified: false, error: error.message };
    }
}

// OTP Verification using SweetAlert
async function showOTPVerification() {
    // Step 1: Ask for phone number
    const { value: phoneInput } = await Swal.fire({
        title: 'Masukkan Nomor Telepon',
        html: `
            <div class="text-left space-y-4">
                <div class="alert alert-info text-sm">
                    <i class="fas fa-info-circle"></i>
                    <span>Nomor telepon Anda perlu diverifikasi untuk melihat hasil estimasi</span>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">Negara</label>
                        <select id="country-select" class="w-full p-2 border rounded">
                            <option value="+60">ðŸ‡²ðŸ‡¾ Malaysia (+60)</option>
                            <option value="+62">ðŸ‡®ðŸ‡© Indonesia (+62)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Nomor Telepon</label>
                        <input type="tel" id="phone-input" class="w-full p-2 border rounded" placeholder="Contoh: 123456789">
                        <small class="text-gray-500">Masukkan nomor tanpa kode negara</small>
                    </div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-paper-plane mr-2"></i>Kirim OTP',
        cancelButtonText: '<i class="fas fa-arrow-left mr-2"></i>Kembali',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        allowOutsideClick: false,
        allowEscapeKey: false,
        preConfirm: () => {
            const countryCode = document.getElementById('country-select').value;
            const phone = document.getElementById('phone-input').value;
            
            if (!phone || phone.trim() === '') {
                Swal.showValidationMessage('Silakan masukkan nomor telepon');
                return false;
            }
            
            if (!/^\d+$/.test(phone.trim())) {
                Swal.showValidationMessage('Nomor telepon hanya boleh berisi angka');
                return false;
            }
            
            return countryCode + phone.trim();
        }
    });

    if (phoneInput) {
        phoneNumber = phoneInput;
        
        // First check if phone is already verified
        const countryCode = phoneNumber.startsWith('+60') ? '+60' : '+62';
        const phoneStatus = await checkPhoneStatus(phoneNumber, countryCode);
        
        if (phoneStatus.verified) {
            // Phone already verified, skip OTP and load results
            await Swal.fire({
                icon: 'success',
                title: 'Nomor Sudah Terverifikasi!',
                text: 'Nomor telepon Anda sudah aktif. Mengambil hasil estimasi...',
                showConfirmButton: false,
                timer: 1500
            });
            
            await loadResults();
        } else {
            // Phone not verified, continue with OTP process
            await sendOTPCode();
        }
    } else {
        window.location.href = '{% url "main:index" %}';
    }
}

async function sendOTPCode() {
    try {
        // Show loading
        Swal.fire({
            title: 'Mengirim OTP...',
            text: 'Mohon tunggu sebentar',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const countryCode = phoneNumber.startsWith('+60') ? '+60' : '+62';
        const phoneOnly = phoneNumber.replace(countryCode, '');
        
        const response = await fetch('/api/send-otp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phoneOnly,
                country_code: countryCode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show OTP for testing in console
            if (data.otp) {
                console.log('OTP untuk testing:', data.otp);
            }
            
            await showOTPInput(data.otp); // Pass OTP for testing
        } else {
            throw new Error(data.error || 'Gagal mengirim OTP');
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Gagal Mengirim OTP',
            text: error.message,
            confirmButtonText: 'Coba Lagi'
        }).then(() => {
            showOTPVerification();
        });
    }
}

async function showOTPInput(testOTP = null) {
    let timeLeft = 60;
    let timerInterval;

    const { value: otpCode } = await Swal.fire({
        title: 'Masukkan Kode OTP',
        html: `
            <div class="space-y-4">
                <div class="alert alert-success text-sm">
                    <i class="fas fa-check-circle"></i>
                    <span>OTP telah dikirim ke ${phoneNumber}</span>
                </div>
                ${testOTP ? `<div class="alert alert-info text-sm"><strong>Testing OTP: ${testOTP}</strong></div>` : ''}
                <input type="text" id="otp-input" class="swal2-input text-center text-2xl" placeholder="123456" maxlength="6" autocomplete="off" style="font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem;">
                <div class="text-sm text-gray-500" id="otp-timer">Berlaku selama <strong>60</strong> detik</div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Verifikasi',
        cancelButtonText: 'Kirim Ulang',
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#f59e0b',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            const input = document.getElementById('otp-input');
            const timer = document.getElementById('otp-timer');
            
            // Focus on input
            input.focus();
            
            // Only allow numbers
            input.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value.length === 6) {
                    Swal.clickConfirm();
                }
            });
            
            // Start countdown
            timerInterval = setInterval(() => {
                timeLeft--;
                timer.innerHTML = `Berlaku selama <strong>${timeLeft}</strong> detik`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timer.innerHTML = '<strong class="text-red-500">Kode OTP kedaluwarsa</strong>';
                }
            }, 1000);
        },
        willClose: () => {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        },
        inputValidator: (value) => {
            if (!value) {
                return 'Silakan masukkan kode OTP!';
            }
            if (value.length !== 6) {
                return 'Kode OTP harus 6 digit!';
            }
            if (!/^\d+$/.test(value)) {
                return 'Kode OTP hanya boleh berisi angka!';
            }
        },
        preConfirm: async (otpCode) => {
            const input = document.getElementById('otp-input');
            return input.value;
        }
    });

    if (otpCode) {
        await verifyOTPCode(otpCode);
    } else {
        // User clicked "Kirim Ulang"
        await sendOTPCode();
    }
}

async function verifyOTPCode(otpCode) {
    try {
        // Show loading
        Swal.fire({
            title: 'Memverifikasi OTP...',
            text: 'Mohon tunggu sebentar',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const countryCode = phoneNumber.startsWith('+60') ? '+60' : '+62';
        const phoneOnly = phoneNumber.replace(countryCode, '');
        
        const response = await fetch('/api/verify-otp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phoneOnly,
                country_code: countryCode,
                otp: otpCode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            await Swal.fire({
                icon: 'success',
                title: 'Verifikasi Berhasil!',
                text: 'Nomor telepon Anda telah diverifikasi. Mengambil hasil estimasi...',
                showConfirmButton: false,
                timer: 1500
            });
            
            // Now load the results
            await loadResults();
        } else {
            throw new Error(data.error || 'Verifikasi gagal');
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Verifikasi Gagal',
            text: error.message,
            confirmButtonText: 'Coba Lagi'
        }).then(() => {
            showOTPVerification();
        });
    }
}

async function loadResults() {
    try {
        const response = await fetch('/api/get-results/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone_number: phoneNumber
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.result) {
            displayResults(data.result);
        } else if (data.no_data) {
            showNoDataState();
        } else {
            throw new Error(data.message || 'Gagal mengambil hasil');
        }
    } catch (error) {
        showErrorState(error.message);
    }
}

function displayResults(result) {
    // Hide loading state
    document.getElementById('loadingState').classList.add('hidden');
    
    // Show results container
    const resultsContainer = document.getElementById('resultsContainer');
    resultsContainer.classList.remove('hidden');
    
    // Populate results
    resultsContainer.innerHTML = generateResultsHTML(result);
    
    // Show actions
    document.getElementById('resultActions').classList.remove('hidden');
}

function generateResultsHTML(result) {
    return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Market Statistics -->
            <div class="space-y-6">
                <h3 class="text-xl font-bold text-base-content flex items-center">
                    <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                    Data Pasar
                </h3>
                
                <div class="card bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200">
                    <div class="card-body p-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-base-content flex items-center">
                                    <i class="fas fa-tachometer-alt text-blue-500 mr-2"></i>
                                    Rata-rata Mileage:
                                </span>
                                <span class="font-bold text-lg text-blue-600">${Math.round(result.rata_rata_mileage_bulat)} km</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-base-content flex items-center">
                                    <i class="fas fa-money-bill-wave text-green-500 mr-2"></i>
                                    Rata-rata Harga:
                                </span>
                                <span class="font-bold text-lg text-green-600">RM ${Math.round(result.rata_rata_price_bulat).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-base-content flex items-center">
                                    <i class="fas fa-database text-purple-500 mr-2"></i>
                                    Total Data:
                                </span>
                                <span class="font-bold text-lg text-purple-600">${result.total_data} unit</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Price Estimation -->
            <div class="space-y-6">
                <h3 class="text-xl font-bold text-base-content flex items-center">
                    <i class="fas fa-calculator text-green-600 mr-2"></i>
                    Estimasi Harga Anda
                </h3>
                
                <div class="card bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200">
                    <div class="card-body p-6">
                        ${result.user_mileage ? `
                            <div class="space-y-3 mb-6">
                                <div class="flex justify-between items-center">
                                    <span class="text-base-content flex items-center">
                                        <i class="fas fa-user-check text-blue-500 mr-2"></i>
                                        Mileage Anda:
                                    </span>
                                    <span class="font-semibold">${Math.round(result.user_mileage).toLocaleString()} km</span>
                                </div>
                                ${result.mileage_diff_percent > 0 ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-base-content/70">Selisih Mileage:</span>
                                        <span class="badge badge-warning">+${result.mileage_diff_percent}%</span>
                                    </div>
                                ` : result.mileage_diff_percent < 0 ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-base-content/70">Selisih Mileage:</span>
                                        <span class="badge badge-success">${result.mileage_diff_percent}%</span>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="space-y-4 mb-6">
                            <h4 class="font-semibold text-base-content flex items-center">
                                <i class="fas fa-minus-circle text-red-500 mr-2"></i>
                                Pengurangan Harga:
                            </h4>
                            
                            ${result.layer1_reduction > 0 ? `
                                <div class="flex justify-between items-center">
                                    <span class="text-base-content/70">â€¢ Berdasarkan Mileage:</span>
                                    <span class="badge badge-error">-${result.layer1_reduction}%</span>
                                </div>
                            ` : ''}
                            
                            ${result.layer2_reduction > 0 ? `
                                <div class="flex justify-between items-center">
                                    <span class="text-base-content/70">â€¢ Berdasarkan Kondisi:</span>
                                    <span class="badge badge-error">-${result.layer2_reduction}%</span>
                                </div>
                            ` : ''}
                            
                            ${result.total_reduction > 0 ? `
                                <div class="divider"></div>
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-base-content">Total Pengurangan:</span>
                                    <span class="badge badge-error badge-lg font-bold">-${result.total_reduction}%</span>
                                </div>
                            ` : `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Tidak ada pengurangan harga
                                </div>
                            `}
                        </div>
                        
                        <div class="bg-base-100 rounded-xl p-4 border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <span class="text-base-content font-bold text-lg flex items-center">
                                    <i class="fas fa-tags text-green-600 mr-2"></i>
                                    Estimasi Harga:
                                </span>
                                <span class="text-2xl font-bold text-green-600">RM ${Math.round(result.adjusted_price).toLocaleString()}</span>
                            </div>
                            ${result.price_savings > 0 ? `
                                <p class="text-sm text-green-600 text-right mt-2 flex items-center justify-end">
                                    <i class="fas fa-piggy-bank mr-1"></i>
                                    Hemat RM ${Math.round(result.price_savings).toLocaleString()}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        ${result.condition_breakdown ? `
            <div class="card bg-gradient-to-r from-gray-50 to-slate-50 border border-base-200 mt-8">
                <div class="card-body p-6">
                    <h4 class="font-bold text-base-content mb-4 flex items-center">
                        <i class="fas fa-list-ul text-base-content/60 mr-2"></i>
                        Detail Penilaian Kondisi:
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        ${Object.entries(result.condition_breakdown).map(([key, value]) => {
                            if (value > 0) {
                                const labels = {
                                    'exterior_condition': 'Exterior',
                                    'interior_condition': 'Interior',
                                    'mechanical_condition': 'Mechanical',
                                    'accident_history': 'Accident',
                                    'service_history': 'Service',
                                    'number_of_owners': 'Owners',
                                    'tires_brakes': 'Tires/Brakes',
                                    'modifications': 'Modifications',
                                    'market_demand': 'Market Demand',
                                    'brand_category': 'Brand Category',
                                    'price_tier': 'Price Tier'
                                };
                                return `
                                    <div class="flex justify-between items-center bg-base-100 rounded-lg p-2">
                                        <span class="text-sm">${labels[key] || key}:</span>
                                        <span class="badge badge-error badge-sm">-${value}%</span>
                                    </div>
                                `;
                            }
                            return '';
                        }).join('')}
                    </div>
                </div>
            </div>
        ` : ''}
    `;
}

function showNoDataState() {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('noDataState').classList.remove('hidden');
}

function showErrorState(message) {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorState').classList.remove('hidden');
}

function shareResult() {
    if (navigator.share) {
        navigator.share({
            title: 'Hasil Estimasi Harga Kendaraan',
            text: 'Lihat hasil estimasi harga kendaraan dari Car Market Price',
            url: window.location.href
        });
    } else {
        // Fallback - copy URL to clipboard
        navigator.clipboard.writeText(window.location.href).then(function() {
            Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: 'Link hasil estimasi telah disalin ke clipboard.',
                confirmButtonText: 'OK'
            });
        });
    }
}

// Add print styles
const printStyles = `
@media print {
    .btn, .navbar, .footer, .dropdown {
        display: none !important;
    }
    
    .card {
        border: 1px solid #e5e5e5 !important;
        box-shadow: none !important;
    }
    
    .bg-gradient-to-r {
        background: #f8fafc !important;
    }
}
`;

const styleElement = document.createElement('style');
styleElement.textContent = printStyles;
document.head.appendChild(styleElement);
</script>
{% endblock %}