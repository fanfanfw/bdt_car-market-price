{% extends 'main/base.html' %}
{% load static %}

{% block title %}Price Estimation Result - Car Market Price{% endblock %}

{% block content %}
<!-- Simple Results Header -->
<div class="text-center mb-10">
    <div class="w-16 h-16 bg-green-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-check-circle text-2xl text-white"></i>
    </div>
    
    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4">
        Price Estimation Complete
    </h1>
    <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Your vehicle valuation is ready based on real market data and current conditions
    </p>
</div>

{% if phone_expired %}
<!-- Phone Verification Expired -->
<div class="alert alert-warning shadow-lg mb-8">
    <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-2xl"></i>
        <div>
            <h4 class="text-lg font-bold">Phone Verification Expired</h4>
            <p>Verification for number {{ phone_number }} has expired. Please verify again.</p>
        </div>
    </div>
</div>

<div class="text-center">
    <a href="{% url 'main:index' %}" class="btn btn-primary">
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Form
    </a>
</div>

{% else %}
<!-- Simple Results Container -->
<div class="bg-white rounded-2xl shadow-lg border border-gray-200 mb-8">
    <div class="p-6 sm:p-8">
        <!-- Vehicle Info Header -->
        <div class="text-center pb-6 border-b border-gray-200 mb-8">
            <div class="bg-blue-50 rounded-xl p-6">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-car text-white"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3">
                    {{ car_info }}
                </h2>
                <div class="flex justify-center items-center gap-4 text-sm text-gray-600">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span>Verified</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Simple Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading loading-spinner loading-lg text-primary mb-6"></div>
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Processing Your Data</h3>
            
            <div class="max-w-sm mx-auto space-y-3 mb-6">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm text-gray-700">Market analysis</span>
                    <div class="loading loading-spinner loading-xs"></div>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm text-gray-700">Phone verification</span>
                    <div class="loading loading-spinner loading-xs"></div>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm text-gray-700">Price calculation</span>
                    <div class="loading loading-spinner loading-xs"></div>
                </div>
            </div>
            
            <p class="text-sm text-gray-500">Please wait 10-15 seconds</p>
        </div>
            
            <!-- Enhanced Results Container (Hidden initially) -->
            <div id="resultsContainer" class="hidden">
                <!-- Results will be populated here via JavaScript with enhanced styling -->
            </div>
        
        <!-- No Data State (Hidden initially) -->
        <div id="noDataState" class="hidden text-center py-8 px-4">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle text-xl sm:text-2xl"></i>
                <div>
                    <h4 class="text-base sm:text-lg font-bold">Data Not Found</h4>
                    <p class="text-sm sm:text-base">No data available for the selected combination. Please try another combination.</p>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'main:index' %}" class="btn btn-primary btn-sm sm:btn-md">
                    <i class="fas fa-arrow-left mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Back to Form</span>
                    <span class="sm:hidden">Back</span>
                </a>
            </div>
        </div>
        
        <!-- Error State (Hidden initially) -->
        <div id="errorState" class="hidden text-center py-8 px-4">
            <div class="alert alert-error">
                <i class="fas fa-times-circle text-xl sm:text-2xl"></i>
                <div>
                    <h4 class="text-base sm:text-lg font-bold">An Error Occurred</h4>
                    <p id="errorMessage" class="text-sm sm:text-base">Unable to process data. Please try again.</p>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'main:index' %}" class="btn btn-primary btn-sm sm:btn-md">
                    <i class="fas fa-arrow-left mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Back to Form</span>
                    <span class="sm:hidden">Back</span>
                </a>
            </div>
        </div>
        
        <!-- Simple Action Buttons (Hidden initially) -->
        <div id="resultActions" class="hidden border-t border-gray-200 pt-6 mt-6">
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{% url 'main:index' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-calculator mr-2"></i>
                    New Estimation
                </a>
                
                <div class="flex gap-3 justify-center">
                    <button onclick="window.print()" class="btn btn-outline">
                        <i class="fas fa-print mr-2"></i>
                        Print
                    </button>
                    <button onclick="shareResult()" class="btn btn-outline">
                        <i class="fas fa-share-alt mr-2"></i>
                        Share
                    </button>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <p class="text-sm text-gray-500">
                    Thank you for using Car Market Price
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let phoneNumber = '{{ verified_phone|default:"" }}';
const phoneNotVerified = {{ phone_not_verified|yesno:"true,false" }};
const skipOTP = {{ skip_otp|yesno:"true,false" }};

// OTP Configuration - dynamically loaded from backend
const OTP_CONFIG = {
    provider: '{{ otp_provider|default:"copycode" }}',
    digits: {{ otp_digits|default:6 }},
    expiry: {{ otp_expiry_seconds|default:300 }}  // Automatically synced from backend OTP_EXPIRY_MINUTES
};

// Auto-start verification process
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Debug - skipOTP:', skipOTP);
    console.log('Debug - phoneNumber:', phoneNumber);
    console.log('Debug - phoneNotVerified:', phoneNotVerified);
    console.log('Debug - OTP_CONFIG loaded from backend:', OTP_CONFIG);

    // Detect OTP provider configuration from backend
    await detectOTPConfig();

    if (skipOTP && phoneNumber) {
        // Phone already verified, load results directly
        console.log('Loading results directly - phone already verified');
        loadResults();
    } else if (phoneNotVerified) {
        // Phone needs verification, show OTP popup
        console.log('Showing OTP verification popup');
        showOTPVerification();
    }
});

// Detect OTP configuration from backend
async function detectOTPConfig() {
    try {
        // You can add an API endpoint to get OTP config or detect from first OTP send response
        // For now, we'll determine based on response structure
        console.log('Using CopyCode configuration: 6 digits, 5 minutes expiry');
        // OTP_CONFIG is already set correctly for CopyCode
    } catch (error) {
        console.log('Using default CopyCode configuration');
    }
}

// Check phone status before asking for OTP
async function checkPhoneStatus(phoneNumber, countryCode) {
    try {
        const phoneOnly = phoneNumber.replace(countryCode, '');
        
        const response = await fetch('/api/check-phone/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phoneOnly,
                country_code: countryCode
            })
        });
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error checking phone status:', error);
        return { verified: false, error: error.message };
    }
}

// Update phone placeholder based on selected country
function updatePhonePlaceholder() {
    const countrySelect = document.getElementById('country-select');
    const phoneInput = document.getElementById('phone-input');
    
    if (countrySelect && phoneInput) {
        if (countrySelect.value === '+60') {
            phoneInput.placeholder = 'Example: 178901234';
        } else {
            phoneInput.placeholder = 'Example: 81234567890';
        }
    }
}

// OTP Verification using SweetAlert
async function showOTPVerification() {
    // Pre-fill phone number if available
    const savedPhoneNumber = phoneNumber || '';
    const savedCountryCode = savedPhoneNumber.startsWith('+60') ? '+60' : '+62';
    const savedPhoneOnly = savedPhoneNumber.replace(/^\+6[02]/, '');
    
    // Step 1: Ask for phone number
    const { value: phoneInput } = await Swal.fire({
        title: 'Enter Phone Number',
        html: `
            <div class="text-left space-y-4">
                <div class="alert alert-info text-sm">
                    <i class="fas fa-info-circle"></i>
                    <span>Your phone number needs to be verified to view the estimation result</span>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">Country</label>
                        <select id="country-select" class="w-full p-2 border rounded" onchange="updatePhonePlaceholder()">
                            <option value="+60" ${savedCountryCode === '+60' ? 'selected' : ''}>🇲🇾 Malaysia (+60)</option>
                            <option value="+62" ${savedCountryCode === '+62' ? 'selected' : ''}>🇮🇩 Indonesia (+62)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Phone Number</label>
                        <input type="tel" id="phone-input" class="w-full p-2 border rounded" placeholder="Example: 81234567890" value="${savedPhoneOnly}">
                        <small class="text-gray-500">Enter number without country code</small>
                    </div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-paper-plane mr-2"></i>Kirim OTP',
        cancelButtonText: '<i class="fas fa-arrow-left mr-2"></i>Kembali',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            // Set initial placeholder based on selected country
            updatePhonePlaceholder();
        },
        preConfirm: () => {
            const countryCode = document.getElementById('country-select').value;
            const phone = document.getElementById('phone-input').value;
            
            if (!phone || phone.trim() === '') {
                Swal.showValidationMessage('Silakan masukkan nomor telepon');
                return false;
            }
            
            if (!/^\d+$/.test(phone.trim())) {
                Swal.showValidationMessage('Nomor telepon hanya boleh berisi angka');
                return false;
            }
            
            return countryCode + phone.trim();
        }
    });

    if (phoneInput) {
        phoneNumber = phoneInput;
        
        // First check if phone is already verified
        const countryCode = phoneNumber.startsWith('+60') ? '+60' : '+62';
        const phoneStatus = await checkPhoneStatus(phoneNumber, countryCode);
        
        if (phoneStatus.verified) {
            // Phone already verified, skip OTP and load results
            await Swal.fire({
                icon: 'success',
                title: 'Nomor Sudah Terverifikasi!',
                text: 'Nomor telepon Anda sudah aktif. Mengambil hasil estimasi...',
                showConfirmButton: false,
                timer: 1500
            });
            
            await loadResults();
        } else {
            // Phone not verified, continue with OTP process
            await sendOTPCode();
        }
    } else {
        window.location.href = '{% url "main:index" %}';
    }
}

async function sendOTPCode() {
    try {
        // Show loading
        Swal.fire({
            title: 'Mengirim OTP...',
            text: 'Please wait a moment',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const countryCode = phoneNumber.startsWith('+60') ? '+60' : '+62';
        const phoneOnly = phoneNumber.replace(countryCode, '');
        
        const response = await fetch('/api/send-otp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phoneOnly,
                country_code: countryCode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('CopyCode OTP sent successfully');
            
            await showOTPInput(null, true); // No auto OTP, user must enter manually from WhatsApp
        } else {
            throw new Error(data.error || 'Gagal mengirim OTP');
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Gagal Mengirim OTP',
            text: error.message,
            confirmButtonText: 'Coba Lagi'
        }).then(() => {
            showOTPVerification();
        });
    }
}

async function showOTPInput(testOTP = null, isNewOTP = true) {
    // Initialize timer only for new OTP requests
    if (isNewOTP) {
        window.otpTimeLeft = OTP_CONFIG.expiry; // Use configured expiry time
        window.otpCancelButtonDisabled = true;
        window.otpVerificationSuccess = false; // Reset success flag
        
        // Clear any existing timer
        if (window.otpTimerInterval) {
            clearInterval(window.otpTimerInterval);
            window.otpTimerInterval = null;
        }
    }

    const showOTPModal = () => {
        return Swal.fire({
            title: 'Enter OTP Code',
            html: `
                <div class="space-y-4">
                    <div class="alert alert-success text-sm">
                        <i class="fas fa-check-circle"></i>
                        <span>OTP has been sent to ${phoneNumber}</span>
                    </div>
                    <input type="text" id="otp-input" class="swal2-input text-center text-2xl" placeholder="Enter ${OTP_CONFIG.digits}-digit code" maxlength="${OTP_CONFIG.digits}" autocomplete="off" style="font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem;">
                    <div class="text-sm text-gray-500" id="otp-timer">Valid for <strong>${window.otpTimeLeft}</strong> seconds</div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Change Number',
            cancelButtonText: 'Resend',
            confirmButtonColor: '#3b82f6',
            cancelButtonColor: '#f59e0b',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                const input = document.getElementById('otp-input');
                const timer = document.getElementById('otp-timer');
                const cancelButton = Swal.getCancelButton();
                
                // Set initial button state based on current timer
                if (cancelButton) {
                    cancelButton.disabled = window.otpCancelButtonDisabled;
                    if (window.otpCancelButtonDisabled) {
                        cancelButton.style.opacity = '0.5';
                        cancelButton.style.cursor = 'not-allowed';
                    } else {
                        cancelButton.style.opacity = '1';
                        cancelButton.style.cursor = 'pointer';
                    }
                }
                
                // Update timer display with current value (show minutes:seconds)
                if (window.otpTimeLeft > 0) {
                    const minutes = Math.floor(window.otpTimeLeft / 60);
                    const seconds = window.otpTimeLeft % 60;
                    const timeDisplay = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds} seconds`;
                    timer.innerHTML = `Valid for <strong>${timeDisplay}</strong>`;
                } else {
                    timer.innerHTML = '<strong class="text-red-500">OTP code expired - Please resend</strong>';
                }
                
                // Focus on input
                input.focus();
                
                // Only allow numbers and auto-submit when reaching configured digit length
                input.addEventListener('input', async function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length === OTP_CONFIG.digits) {
                        // Auto verify when all digits are entered
                        const otpCode = this.value;
                        
                        // Disable input while verifying
                        this.disabled = true;
                        
                        const verificationResult = await verifyOTPCodeSilent(otpCode);
                        
                        if (verificationResult === true) {
                            // Success - close modal and stop timer
                            if (window.otpTimerInterval) {
                                clearInterval(window.otpTimerInterval);
                                window.otpTimerInterval = null;
                            }
                            window.otpTimeLeft = 0;
                            window.otpCancelButtonDisabled = true;
                            window.otpVerificationSuccess = true; // Flag untuk keluar dari loop
                            Swal.close();
                        } else {
                            // Failed - clear input, re-enable, and let user try again
                            this.value = '';
                            this.disabled = false;
                            this.focus();
                            
                            // Show error message briefly
                            const errorMsg = document.createElement('div');
                            errorMsg.className = 'text-red-500 text-sm mt-2';
                            errorMsg.textContent = 'Incorrect OTP code, please try again';
                            timer.parentNode.appendChild(errorMsg);
                            
                            setTimeout(() => {
                                if (errorMsg.parentNode) {
                                    errorMsg.parentNode.removeChild(errorMsg);
                                }
                            }, 2000);
                        }
                    }
                });
                
                // Start countdown only if timer is still running and no existing timer
                if (window.otpTimeLeft > 0 && !window.otpTimerInterval) {
                    window.otpTimerInterval = setInterval(() => {
                        window.otpTimeLeft--;
                        const minutes = Math.floor(window.otpTimeLeft / 60);
                        const seconds = window.otpTimeLeft % 60;
                        const timeDisplay = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds} seconds`;
                        timer.innerHTML = `Valid for <strong>${timeDisplay}</strong>`;

                        if (window.otpTimeLeft <= 0) {
                            clearInterval(window.otpTimerInterval);
                            window.otpTimerInterval = null;
                            timer.innerHTML = '<strong class="text-red-500">OTP code expired - Please resend</strong>';
                            
                            // Enable cancel button when timer expires
                            if (cancelButton) {
                                cancelButton.disabled = false;
                                cancelButton.style.opacity = '1';
                                cancelButton.style.cursor = 'pointer';
                                window.otpCancelButtonDisabled = false;
                            }
                        }
                    }, 1000);
                }
            },
            willClose: () => {
                // Don't clear the global timer here, let it continue running
                // Only clear it when OTP is successful or new OTP is requested
            }
        });
    };

    while (true) {
        const result = await showOTPModal();
        
        if (result.isConfirmed) {
            // User clicked "Ganti Nomor" - go back to phone input modal
            window.otpTimeLeft = 0;
            window.otpCancelButtonDisabled = true;
            await showOTPVerification(); // Go back to phone input
            break;
            
        } else if (result.isDismissed && result.dismiss === Swal.DismissReason.cancel) {
            // User clicked "Kirim Ulang" 
            if (!window.otpCancelButtonDisabled) {
                // Clear existing timer before requesting new OTP
                if (window.otpTimerInterval) {
                    clearInterval(window.otpTimerInterval);
                    window.otpTimerInterval = null;
                }
                
                // Exit current loop and start fresh
                await sendOTPCode();
                return; // Exit function completely, sendOTPCode will call showOTPInput again
            }
            // If button is disabled, just continue showing the modal
        } else if (result.isDismissed) {
            // Modal was closed (either by auto-submit success or other reason)
            // Check if it was auto-submit success
            if (window.otpVerificationSuccess === true) {
                // Success case - exit the function
                window.otpVerificationSuccess = false; // Reset flag
                break;
            }
            // Otherwise continue showing the modal
        } else {
            // User somehow closed the modal (shouldn't happen due to allowOutsideClick: false)
            window.location.href = '{% url "main:index" %}';
            break;
        }
    }
}

// Silent verification without UI changes for auto-submit
async function verifyOTPCodeSilent(otpCode) {
    try {
        const countryCode = phoneNumber.startsWith('+60') ? '+60' : '+62';
        const phoneOnly = phoneNumber.replace(countryCode, '');
        
        const response = await fetch('/api/verify-otp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phoneOnly,
                country_code: countryCode,
                otp: otpCode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success and load results
            await Swal.fire({
                icon: 'success',
                title: 'Verification Successful!',
                text: 'Nomor telepon Anda telah diverifikasi. Mengambil hasil estimasi...',
                showConfirmButton: false,
                timer: 1500
            });
            
            await loadResults();
            return true; // Success
        } else {
            return false; // Failed verification - no UI changes
        }
    } catch (error) {
        return false; // Failed verification - no UI changes
    }
}

async function verifyOTPCode(otpCode, testOTP = null) {
    try {
        // Show loading
        Swal.fire({
            title: 'Verifying OTP...',
            text: 'Please wait a moment',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const countryCode = phoneNumber.startsWith('+60') ? '+60' : '+62';
        const phoneOnly = phoneNumber.replace(countryCode, '');
        
        const response = await fetch('/api/verify-otp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phoneOnly,
                country_code: countryCode,
                otp: otpCode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            await Swal.fire({
                icon: 'success',
                title: 'Verification Successful!',
                text: 'Nomor telepon Anda telah diverifikasi. Mengambil hasil estimasi...',
                showConfirmButton: false,
                timer: 1500
            });
            
            // Now load the results
            await loadResults();
            return true; // Success
        } else {
            // Show error but don't exit - let the caller handle retry
            await Swal.fire({
                icon: 'error',
                title: 'Verification Failed',
                text: data.error || 'Incorrect OTP code. Please try again.',
                showConfirmButton: true,
                confirmButtonText: 'OK',
                timer: 3000
            });
            return false; // Failed verification
        }
    } catch (error) {
        // Show error but don't exit - let the caller handle retry
        await Swal.fire({
            icon: 'error',
            title: 'Verification Failed',
            text: 'Network error occurred. Please try again.',
            showConfirmButton: true,
            confirmButtonText: 'OK',
            timer: 3000
        });
        return false; // Failed verification
    }
}

async function loadResults() {
    try {
        const response = await fetch('/api/get-results/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone_number: phoneNumber
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.result) {
            displayResults(data.result);
        } else if (data.no_data) {
            showNoDataState();
        } else {
            throw new Error(data.message || 'Failed to get results');
        }
    } catch (error) {
        showErrorState(error.message);
    }
}

function displayResults(result) {
    // Hide loading state
    document.getElementById('loadingState').classList.add('hidden');
    
    // Show results container
    const resultsContainer = document.getElementById('resultsContainer');
    resultsContainer.classList.remove('hidden');
    
    // Populate results
    resultsContainer.innerHTML = generateResultsHTML(result);
    
    // Show actions
    document.getElementById('resultActions').classList.remove('hidden');
}

function generateResultsHTML(result) {
    return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Market Statistics -->
            <div class="bg-blue-50 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                    Market Data
                </h3>
                
                <div class="space-y-4">
                    <div class="bg-white rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Average Mileage</span>
                            <span class="text-lg font-semibold text-blue-600">
                                ${Math.round(result.rata_rata_mileage_bulat).toLocaleString()} km
                            </span>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Average Price</span>
                            <span class="text-lg font-semibold text-green-600">
                                RM ${Math.round(result.rata_rata_price_bulat).toLocaleString()}
                            </span>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Sample Size</span>
                            <span class="text-lg font-semibold text-purple-600">
                                ${result.total_data} units
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Price Estimation -->
            <div class="bg-green-50 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-calculator text-green-600 mr-2"></i>
                    Your Estimation
                </h3>
                
                <div class="space-y-4">
                    ${result.user_mileage ? `
                        <div class="bg-white rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Your Mileage</span>
                                <span class="text-lg font-semibold">
                                    ${Math.round(result.user_mileage).toLocaleString()} km
                                    ${result.mileage_diff_percent > 0 ? 
                                        `<span class="text-red-500 text-xs ml-1">(+${result.mileage_diff_percent.toFixed(1)}%)</span>` : 
                                        result.mileage_diff_percent < 0 ?
                                        `<span class="text-green-500 text-xs ml-1">(${result.mileage_diff_percent.toFixed(1)}%)</span>` : ''
                                    }
                                </span>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${result.total_reduction > 0 ? `
                        <div class="bg-white rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-3">Price Adjustments</div>
                            <div class="space-y-2">
                                ${result.layer1_reduction > 0 ? `
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-500">Mileage Factor</span>
                                        <span class="text-red-500">-${result.layer1_reduction.toFixed(1)}%</span>
                                    </div>
                                ` : ''}
                                ${result.layer2_reduction > 0 ? `
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-500">Condition Factor</span>
                                        <span class="text-red-500">-${result.layer2_reduction.toFixed(1)}%</span>
                                    </div>
                                ` : ''}
                                <hr class="my-2">
                                <div class="flex justify-between font-medium">
                                    <span>Total Reduction</span>
                                    <span class="text-red-500">-${result.total_reduction.toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Final Price -->
                    <div class="bg-green-100 border-2 border-green-200 rounded-lg p-6 text-center">
                        <div class="text-sm text-gray-600 mb-2">Estimated Value</div>
                        <div class="text-3xl font-bold text-green-600 mb-2">
                            RM ${Math.round(result.adjusted_price || result.rata_rata_price_bulat).toLocaleString()}
                        </div>
                        ${result.price_savings > 0 ? `
                            <div class="text-sm text-red-500">
                                RM ${Math.round(result.price_savings).toLocaleString()} below market average
                            </div>
                        ` : `
                            <div class="text-sm text-green-600">
                                At market average price
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>
        
        ${result.condition_breakdown ? `
            <div class="bg-gray-50 rounded-xl p-6 mt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-list-ul text-gray-600 mr-2"></i>
                    Condition Breakdown
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    ${Object.entries(result.condition_breakdown).map(([key, value]) => {
                        if (value > 0) {
                            const labels = {
                                'exterior_condition': 'Exterior',
                                'interior_condition': 'Interior',
                                'mechanical_condition': 'Mechanical',
                                'accident_history': 'Accident History',
                                'service_history': 'Service Record',
                                'number_of_owners': 'Previous Owners',
                                'tires_brakes': 'Tires & Brakes',
                                'modifications': 'Modifications',
                                'market_demand': 'Market Demand',
                                'brand_category': 'Brand Category',
                                'price_tier': 'Price Tier'
                            };
                            
                            return `
                                <div class="bg-white rounded-lg p-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-700">${labels[key] || key}</span>
                                        <span class="text-sm font-semibold text-red-500">-${value}%</span>
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    }).join('')}
                </div>
            </div>
        ` : ''}
        
        ${(result.brand_category_info || result.price_tier_info) ? `
            <div class="bg-blue-50 rounded-xl p-6 mt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-robot text-blue-600 mr-2"></i>
                    Auto-Detection Summary
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${result.brand_category_info ? `
                        <div class="bg-white rounded-lg p-4 border-l-4 border-purple-500">
                            <h4 class="font-semibold text-gray-900 mb-2 flex items-center">
                                <i class="fas fa-tags text-purple-500 mr-2"></i>
                                Brand Category
                            </h4>
                            <div class="text-sm text-gray-600 mb-2">
                                Brand: <span class="font-medium">${result.brand_category_info.brand}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                Category: <span class="font-medium">${result.brand_category_info.category}</span>
                            </div>
                            <div class="text-sm">
                                Reduction: <span class="font-semibold text-red-500">-${result.brand_category_info.reduction}%</span>
                            </div>
                            ${result.brand_category_info.warning ? `
                                <div class="mt-2 text-xs text-amber-600 bg-amber-50 p-2 rounded">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    ${result.brand_category_info.warning}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${result.price_tier_info ? `
                        <div class="bg-white rounded-lg p-4 border-l-4 border-green-500">
                            <h4 class="font-semibold text-gray-900 mb-2 flex items-center">
                                <i class="fas fa-layer-group text-green-500 mr-2"></i>
                                Price Tier
                            </h4>
                            <div class="text-sm text-gray-600 mb-2">
                                Average Price: <span class="font-medium">RM ${Math.round(result.price_tier_info.average_price).toLocaleString()}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                Tier: <span class="font-medium">${result.price_tier_info.tier_name}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                Range: <span class="font-medium">${result.price_tier_info.price_range}</span>
                            </div>
                            <div class="text-sm">
                                Reduction: <span class="font-semibold text-red-500">-${result.price_tier_info.reduction}%</span>
                            </div>
                            ${result.price_tier_info.warning ? `
                                <div class="mt-2 text-xs text-amber-600 bg-amber-50 p-2 rounded">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    ${result.price_tier_info.warning}
                                </div>
                            ` : ''}
                            ${result.price_tier_info.error ? `
                                <div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    ${result.price_tier_info.error}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            </div>
        ` : ''}
    `;
}

function showNoDataState() {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('noDataState').classList.remove('hidden');
}

function showErrorState(message) {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorState').classList.remove('hidden');
}

function shareResult() {
    if (navigator.share) {
        navigator.share({
            title: 'Vehicle Price Estimation Result',
            text: 'Check out vehicle price estimation results from Car Market Price',
            url: window.location.href
        });
    } else {
        // Fallback - copy URL to clipboard
        navigator.clipboard.writeText(window.location.href).then(function() {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Estimation result link has been copied to clipboard.',
                confirmButtonText: 'OK'
            });
        });
    }
}

// Add print styles
const printStyles = `
@media print {
    .btn, .navbar, .footer, .dropdown {
        display: none !important;
    }
    
    .card {
        border: 1px solid #e5e5e5 !important;
        box-shadow: none !important;
    }
    
    .bg-gradient-to-r {
        background: #f8fafc !important;
    }
}
`;

const styleElement = document.createElement('style');
styleElement.textContent = printStyles;
document.head.appendChild(styleElement);
</script>
{% endblock %}