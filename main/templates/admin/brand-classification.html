{% extends 'admin/base-admin.html' %}

{% block title %}Brand Classification - Admin Panel{% endblock %}
{% block page_title %}Brand Classification{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Basic content test -->
    <h1 class="text-2xl font-bold text-gray-900">Brand Classification</h1>
    <p class="text-gray-600">Basic test content</p>
    
    <!-- Statistics Cards Test -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Brands</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_brands }}</p>
                    <p class="text-xs text-gray-500">Unique brands</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-car text-xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Classified</p>
                    <p class="text-2xl font-bold text-gray-900">{{ classified_brands }}</p>
                    <p class="text-xs text-gray-500">Brands assigned</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-check-circle text-xl text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Unclassified</p>
                    <p class="text-2xl font-bold text-gray-900">{{ unclassified_brands }}</p>
                    <p class="text-xs text-gray-500">Need classification</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-xl text-red-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Progress</p>
                    <p class="text-2xl font-bold text-gray-900">{% widthratio classified_brands total_brands 100 %}%</p>
                    <p class="text-xs text-gray-500">Classification complete</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-percentage text-xl text-purple-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Warning for Unclassified Brands Test -->
    {% if unclassified_brands > 0 %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-4">
        <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-yellow-600"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-yellow-800">{{ unclassified_brands }} Brands Need Classification</h3>
                <p class="text-sm text-yellow-700 mt-1">Users submitting forms with unclassified brands will receive 0% reduction for the brand category layer.</p>
                <div class="flex gap-2 mt-3">
                    <button class="px-3 py-1.5 text-xs font-medium text-yellow-700 bg-yellow-100 border border-yellow-300 rounded-lg hover:bg-yellow-200 transition-colors" onclick="filterUnclassified()">
                        <i class="fas fa-filter mr-1"></i>Show Unclassified
                    </button>
                    <button class="px-3 py-1.5 text-xs font-medium text-green-700 bg-green-100 border border-green-300 rounded-lg hover:bg-green-200 transition-colors" onclick="bulkAssign()">
                        <i class="fas fa-magic mr-1"></i>Bulk Assign
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filters Test -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-filter text-gray-600"></i>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Filters</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Status</label>
                <select id="statusFilter" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="classified">Classified</option>
                    <option value="unclassified">Unclassified</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Category</label>
                <select id="categoryFilter" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Actions</label>
                <div class="flex gap-2">
                    <button class="flex-1 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors" onclick="clearFilters()">
                        <i class="fas fa-times mr-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table Test -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-table text-gray-600"></i>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Brand Classification</h2>
        </div>
        
        <!-- Table Structure Test -->
        <div class="overflow-x-auto">
            <table id="brandsTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brand Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Car Count</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Test Brand</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">100</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Classified</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Continental</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Actions</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Assign Brand Modal -->
<div class="fixed inset-0 z-50 hidden" id="assignModal">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black opacity-50" onclick="closeAssignModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full z-10">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-plus text-blue-600" id="assignIcon"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900" id="assignModalTitle">Assign Brand to Category</h3>
                </div>
            </div>
            
            <div class="p-6">
                <form id="assignForm" class="space-y-4">
                    {% csrf_token %}
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Brand Name</label>
                        <input type="text" id="assignBrandName" class="block w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Select Category</label>
                        <select id="assignCategoryId" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Choose a category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors" onclick="closeAssignModal()">Cancel</button>
                        <button type="button" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors" id="confirmAssignBtn" onclick="confirmAssignment()">
                            <i class="fas fa-check mr-2"></i><span id="assignBtnText">Assign Brand</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('Brand classification JS loaded - testing DataTable init');

$(document).ready(function() {
    console.log('Initializing DataTable...');
    
    try {
        $('#brandsTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: '{% url "main:brands_data_api" %}',
                type: 'GET',
                data: function(d) {
                    d.status_filter = $('#statusFilter').val();
                    d.category_filter = $('#categoryFilter').val();
                }
            },
            columns: [
                { 
                    data: 0,
                    render: function(data, type, row) {
                        return `<span class="brand-name">${data}</span>`;
                    }
                },
                { data: 1 },
                { data: 2 },
                { data: 3 },
                { 
                    data: 4,
                    orderable: false,
                    searchable: false,
                    className: 'action-buttons'
                }
            ],
            pageLength: 25,
            lengthMenu: [10, 25, 50, 100],
            order: [[0, 'asc']],
            dom: '<"flex justify-between items-center mb-4"lf>rtip',
            language: {
                processing: '<div class="flex items-center gap-2"><i class="fas fa-spinner fa-spin text-blue-600"></i>Loading brands...</div>',
                search: '',
                searchPlaceholder: 'Search brands...',
                lengthMenu: 'Show _MENU_ entries',
                info: 'Showing _START_ to _END_ of _TOTAL_ entries',
                infoEmpty: 'Showing 0 to 0 of 0 entries',
                infoFiltered: '(filtered from _MAX_ total entries)',
                paginate: {
                    first: '<<',
                    last: '>>',
                    next: '>',
                    previous: '<'
                }
            },
            drawCallback: function(settings) {
                // Apply Tailwind classes after redraw
                $('.dataTables_length select').addClass('px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500');
                $('.dataTables_filter input').addClass('px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500');
            }
        });
        console.log('DataTable initialized successfully');
        
        // Filter event listeners
        $('#statusFilter, #categoryFilter').on('change', function() {
            $('#brandsTable').DataTable().ajax.reload();
        });
        
    } catch(error) {
        console.error('DataTable initialization error:', error);
    }
});

// Filter functions
function clearFilters() {
    $('#statusFilter').val('');
    $('#categoryFilter').val('');
    $('#brandsTable').DataTable().ajax.reload();
}

function filterUnclassified() {
    $('#statusFilter').val('unclassified');
    $('#brandsTable').DataTable().ajax.reload();
}

function refreshTable() {
    $('#brandsTable').DataTable().ajax.reload(null, false);
}

function bulkAssign() {
    Swal.fire({
        title: 'Bulk Assignment',
        text: 'This feature will be implemented in future updates.',
        icon: 'info'
    });
}

// Brand assignment functions  
let currentAssignData = {};

function assignBrand(brandName) {
    currentAssignData = {
        brand: brandName,
        isReassign: false
    };
    
    $('#assignModalTitle').text('Assign Brand to Category');
    $('#assignIcon').removeClass('fa-exchange-alt').addClass('fa-plus');
    $('#assignBtnText').text('Assign Brand');
    $('#assignBrandName').val(brandName);
    $('#assignCategoryId').val('');
    
    document.getElementById('assignModal').classList.remove('hidden');
}

function reassignBrand(brandName, categoryId, mappingId) {
    currentAssignData = {
        brand: brandName,
        categoryId: categoryId,
        mappingId: mappingId,
        isReassign: true
    };
    
    $('#assignModalTitle').text('Reassign Brand to Category');
    $('#assignIcon').removeClass('fa-plus').addClass('fa-exchange-alt');
    $('#assignBtnText').text('Reassign Brand');
    $('#assignBrandName').val(brandName);
    $('#assignCategoryId').val(categoryId);
    
    document.getElementById('assignModal').classList.remove('hidden');
}

function closeAssignModal() {
    document.getElementById('assignModal').classList.add('hidden');
}

function confirmAssignment() {
    const categoryId = $('#assignCategoryId').val();
    if (!categoryId) {
        Swal.fire('Error', 'Please select a category', 'error');
        return;
    }
    
    const confirmBtn = document.getElementById('confirmAssignBtn');
    const originalContent = confirmBtn.innerHTML;
    
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    confirmBtn.disabled = true;
    
    const url = currentAssignData.isReassign ? 
        '{% url "main:reassign_brand_to_category" %}' :
        '{% url "main:assign_brand_to_category" %}';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            brand_name: currentAssignData.brand,
            category_id: categoryId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Success!', data.message, 'success');
            closeAssignModal();
            $('#brandsTable').DataTable().ajax.reload();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            throw new Error(data.error || 'Failed to assign brand');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', error.message, 'error');
    })
    .finally(() => {
        confirmBtn.innerHTML = originalContent;
        confirmBtn.disabled = false;
    });
}

function removeBrandClassification(brandName, mappingId) {
    Swal.fire({
        title: 'Remove Brand Classification',
        text: `Remove "${brandName}" from its current category?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Remove',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#dc2626'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('{% url "main:remove_brand_classification" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    brand: brandName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Removed!', data.message, 'success');
                    $('#brandsTable').DataTable().ajax.reload();
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    throw new Error(data.error || 'Failed to remove brand');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', error.message, 'error');
            });
        }
    });
}

// Utility functions
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           getCookie('csrftoken');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}