{% extends 'admin/base-admin.html' %}

{% block title %}Condition Categories - Admin Panel{% endblock %}
{% block page_title %}Condition Categories{% endblock %}

{% block extra_css %}
<style>
    .option-item {
        transition: all 0.2s ease;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .option-item:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .category-card {
        transition: all 0.2s ease;
    }
    
    .category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6" x-data="conditionCategoriesManager()">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold">Condition Categories</h1>
            <p class="text-base-content/60 mt-1">Manage vehicle condition categories and reduction percentages</p>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <div>
            <h3 class="font-bold">Layer 2: Fixed Vehicle Condition Categories</h3>
            <div class="text-sm">These categories are fixed in the system. You can only edit the options and their reduction percentages.</div>
        </div>
    </div>

    <!-- Brand Category Special Notice -->
    <div class="alert alert-warning">
        <i class="fas fa-car"></i>
        <div class="flex-1">
            <h3 class="font-bold">Brand Category Configuration</h3>
            <div class="text-sm">The "Brand Category" is handled automatically based on car brand classification. Users don't need to select this manually.</div>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'main:categories_management_view' %}" class="btn btn-sm btn-primary">
                <i class="fas fa-tags"></i>
                Manage Categories
            </a>
            <a href="{% url 'main:brand_classification_view' %}" class="btn btn-sm btn-success">
                <i class="fas fa-cog"></i>
                Classify Brands
            </a>
        </div>
    </div>

    <!-- Categories Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% for category in categories %}
        <div class="card bg-base-100 shadow category-card">
            <div class="card-header bg-base-200">
                <div class="flex justify-between items-center">
                    <h3 class="card-title">
                        <i class="fas fa-cog"></i>
                        {{ category.display_name }}
                    </h3>
                    <div class="badge badge-primary">{{ category.options.count }} options</div>
                </div>
            </div>
            <div class="card-body">
                <div class="space-y-2">
                    {% for option in category.options.all %}
                    <div class="option-item flex justify-between items-center" x-data="{ option: {{ option|safe }} }">
                        <div class="flex-1">
                            <span class="font-medium">{{ option.label }}</span>
                            <div class="badge badge-error ml-2">-{{ option.reduction_percentage }}%</div>
                        </div>
                        <div class="flex gap-1">
                            <button 
                                @click="showEditModal({{ option.id }}, '{{ option.label }}', {{ option.reduction_percentage }})"
                                class="btn btn-xs btn-primary"
                                title="Edit Option"
                            >
                                <i class="fas fa-edit"></i>
                            </button>
                            <button 
                                @click="deleteOption({{ option.id }}, '{{ option.label }}')"
                                class="btn btn-xs btn-error"
                                title="Delete Option"
                            >
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="divider"></div>
                <button 
                    @click="showAddModal({{ category.id }}, '{{ category.display_name }}')"
                    class="btn btn-sm btn-success"
                >
                    <i class="fas fa-plus"></i>
                    Add Option
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Edit Option Modal -->
<div class="modal" :class="{ 'modal-open': editModal.show }" x-show="editModal.show">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">
            <i class="fas fa-edit"></i>
            Edit Option
        </h3>
        <form @submit.prevent="saveEditedOption()">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Option Label</span>
                </label>
                <input 
                    type="text" 
                    x-model="editForm.label"
                    class="input input-bordered" 
                    placeholder="Enter option label"
                    required
                >
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Reduction Percentage</span>
                </label>
                <div class="input-group">
                    <input 
                        type="number" 
                        x-model="editForm.percentage"
                        class="input input-bordered flex-1" 
                        step="0.01" 
                        min="0" 
                        max="100"
                        placeholder="0.00"
                        required
                    >
                    <span class="input-group-text">%</span>
                </div>
            </div>
            <div class="modal-action">
                <button type="button" class="btn" @click="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" :disabled="saving">
                    <span x-show="saving">
                        <span class="loading loading-spinner loading-sm"></span>
                        Saving...
                    </span>
                    <span x-show="!saving">Save Changes</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Option Modal -->
<div class="modal" :class="{ 'modal-open': addModal.show }" x-show="addModal.show">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">
            <i class="fas fa-plus"></i>
            Add New Option
        </h3>
        <form @submit.prevent="saveNewOption()">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Category</span>
                </label>
                <input 
                    type="text" 
                    x-model="addForm.categoryName"
                    class="input input-bordered" 
                    readonly
                >
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Option Label</span>
                </label>
                <input 
                    type="text" 
                    x-model="addForm.label"
                    class="input input-bordered" 
                    placeholder="Enter option label"
                    required
                >
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Reduction Percentage</span>
                </label>
                <div class="input-group">
                    <input 
                        type="number" 
                        x-model="addForm.percentage"
                        class="input input-bordered flex-1" 
                        step="0.01" 
                        min="0" 
                        max="100"
                        placeholder="0.00"
                        required
                    >
                    <span class="input-group-text">%</span>
                </div>
            </div>
            <div class="modal-action">
                <button type="button" class="btn" @click="closeAddModal()">Cancel</button>
                <button type="submit" class="btn btn-success" :disabled="saving">
                    <span x-show="saving">
                        <span class="loading loading-spinner loading-sm"></span>
                        Adding...
                    </span>
                    <span x-show="!saving">Add Option</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function conditionCategoriesManager() {
    return {
        // State
        saving: false,
        
        // Edit modal
        editModal: {
            show: false,
            optionId: null
        },
        editForm: {
            label: '',
            percentage: 0
        },
        
        // Add modal
        addModal: {
            show: false,
            categoryId: null
        },
        addForm: {
            categoryName: '',
            label: '',
            percentage: 0
        },
        
        // Show edit modal
        showEditModal(optionId, label, percentage) {
            this.editModal = {
                show: true,
                optionId: optionId
            };
            this.editForm = {
                label: label,
                percentage: percentage
            };
        },
        
        // Close edit modal
        closeEditModal() {
            this.editModal = {
                show: false,
                optionId: null
            };
            this.editForm = {
                label: '',
                percentage: 0
            };
        },
        
        // Save edited option
        async saveEditedOption() {
            this.saving = true;
            
            try {
                const response = await fetch(`/api/condition-option/${this.editModal.optionId}/edit/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        label: this.editForm.label,
                        reduction_percentage: parseFloat(this.editForm.percentage)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await Swal.fire('Success!', 'Option updated successfully', 'success');
                    location.reload();
                } else {
                    throw new Error(data.error || 'Failed to update option');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', error.message, 'error');
            } finally {
                this.saving = false;
            }
        },
        
        // Show add modal
        showAddModal(categoryId, categoryName) {
            this.addModal = {
                show: true,
                categoryId: categoryId
            };
            this.addForm = {
                categoryName: categoryName,
                label: '',
                percentage: 0
            };
        },
        
        // Close add modal
        closeAddModal() {
            this.addModal = {
                show: false,
                categoryId: null
            };
            this.addForm = {
                categoryName: '',
                label: '',
                percentage: 0
            };
        },
        
        // Save new option
        async saveNewOption() {
            this.saving = true;
            
            try {
                const response = await fetch(`/api/condition-category/${this.addModal.categoryId}/option/add/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        label: this.addForm.label,
                        reduction_percentage: parseFloat(this.addForm.percentage)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await Swal.fire('Success!', 'Option added successfully', 'success');
                    location.reload();
                } else {
                    throw new Error(data.error || 'Failed to add option');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', error.message, 'error');
            } finally {
                this.saving = false;
            }
        },
        
        // Delete option
        async deleteOption(optionId, label) {
            const result = await Swal.fire({
                title: 'Delete Option',
                text: `Are you sure you want to delete "${label}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Delete',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#dc2626'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/api/condition-option/${optionId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.getCsrfToken()
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        await Swal.fire('Deleted!', 'Option deleted successfully', 'success');
                        location.reload();
                    } else {
                        throw new Error(data.error || 'Failed to delete option');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', error.message, 'error');
                }
            }
        },
        
        // Utility functions
        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   this.getCookie('csrftoken');
        },
        
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
}

// Note: Condition Categories management migrated from vanilla JavaScript to Alpine.js
// All functionality preserved with modern Alpine.js reactive components
</script>
{% endblock %}