{% extends 'admin/base-admin.html' %}

{% block title %}Manage Conditions - Car Market Price Admin{% endblock %}
{% block page_title %}Manage Conditions{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="breadcrumbs text-sm">
        <ul>
            <li><a href="{% url 'main:pricing_config_list' %}">Configurations</a></li>
            <li><a href="{% url 'main:pricing_config_detail' config.id %}">v{{ config.version }} - {{ config.name }}</a></li>
            <li>Manage Conditions</li>
        </ul>
    </div>

    <!-- Configuration Info -->
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <div>
            <h4 class="font-bold">Editing Configuration: {{ config.name }} (v{{ config.version }})</h4>
            <p>Managing Layer 2 condition assessment categories and their options.</p>
        </div>
    </div>

    <!-- Add New Condition -->
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-plus text-success"></i>
                Add New Condition Category
            </h2>
            
            <form id="addConditionForm" class="space-y-4">
                {% csrf_token %}
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Condition Name</span>
                    </label>
                    <input type="text" id="conditionName" class="input input-bordered" 
                           placeholder="e.g., Engine Condition" required>
                </div>
                
                <div>
                    <label class="label">
                        <span class="label-text font-medium">Options (2-5 options)</span>
                    </label>
                    <div id="optionsContainer" class="space-y-2">
                        <div class="flex gap-2 items-center option-row">
                            <input type="text" class="input input-bordered flex-1 option-label" placeholder="Option Label (e.g., Excellent)" required>
                            <input type="number" class="input input-bordered w-24 option-percentage" placeholder="%" step="0.1" min="0" max="50" value="0" required>
                            <button type="button" class="btn btn-ghost btn-sm remove-option" onclick="removeOption(this)" disabled>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="flex gap-2 items-center option-row">
                            <input type="text" class="input input-bordered flex-1 option-label" placeholder="Option Label (e.g., Good)" required>
                            <input type="number" class="input input-bordered w-24 option-percentage" placeholder="%" step="0.1" min="0" max="50" value="5" required>
                            <button type="button" class="btn btn-ghost btn-sm remove-option" onclick="removeOption(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button type="button" class="btn btn-sm btn-outline" onclick="addOption()" id="addOptionBtn">
                            <i class="fas fa-plus"></i>
                            Add Option
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-end gap-2">
                    <button type="button" class="btn btn-ghost" onclick="resetForm()">Reset</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Add Condition
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Existing Conditions -->
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-list text-info"></i>
                Current Condition Categories ({{ conditions|length }})
            </h2>
            
            {% if conditions %}
            <div class="space-y-4">
                {% for condition in conditions %}
                <div class="card bg-base-200 shadow-sm" id="condition-{{ condition.id }}">
                    <div class="card-body p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h4 class="font-semibold">{{ condition.name }}</h4>
                                <div class="text-sm text-base-content/60">
                                    Field: {{ condition.field_name }} | Max: {{ condition.get_max_percentage }}% | Order: {{ condition.order }}
                                </div>
                            </div>
                            <div class="flex gap-1">
                                <button class="btn btn-sm btn-primary" onclick="editCondition({{ condition.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-error" onclick="deleteCondition({{ condition.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Options -->
                        <div class="flex flex-wrap gap-2">
                            {% for option in condition.options.all %}
                            <span class="badge badge-ghost">{{ option.label }} (-{{ option.percentage }}%)</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-base-content/60">
                <i class="fas fa-inbox text-3xl mb-2"></i>
                <p>No conditions configured. Add your first condition above.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Actions -->
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <div class="flex justify-between items-center">
                <div class="text-sm text-base-content/70">
                    Changes are saved automatically. Remember to publish the configuration when ready.
                </div>
                <div class="flex gap-2">
                    <a href="{% url 'main:pricing_config_detail' config.id %}" class="btn btn-ghost">
                        <i class="fas fa-arrow-left"></i>
                        Back to Configuration
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Condition Modal -->
<div id="editModal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg mb-4">Edit Condition</h3>
        <form id="editConditionForm" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="editConditionId">
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Condition Name</span>
                </label>
                <input type="text" id="editConditionName" class="input input-bordered" required>
            </div>
            
            <div>
                <label class="label">
                    <span class="label-text font-medium">Options</span>
                </label>
                <div id="editOptionsContainer" class="space-y-2">
                    <!-- Options will be loaded dynamically -->
                </div>
                <button type="button" class="btn btn-sm btn-outline mt-2" onclick="addEditOption()">
                    <i class="fas fa-plus"></i>
                    Add Option
                </button>
            </div>
            
            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let optionCount = 2;
const maxOptions = 5;

function addOption() {
    if (optionCount >= maxOptions) {
        Swal.fire('Maximum Reached', `Maximum ${maxOptions} options allowed per condition.`, 'warning');
        return;
    }
    
    const container = document.getElementById('optionsContainer');
    const optionRow = document.createElement('div');
    optionRow.className = 'flex gap-2 items-center option-row';
    optionRow.innerHTML = `
        <input type="text" class="input input-bordered flex-1 option-label" placeholder="Option Label" required>
        <input type="number" class="input input-bordered w-24 option-percentage" placeholder="%" step="0.1" min="0" max="50" value="10" required>
        <button type="button" class="btn btn-ghost btn-sm remove-option" onclick="removeOption(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(optionRow);
    
    optionCount++;
    updateAddButton();
    updateRemoveButtons();
}

function removeOption(button) {
    button.closest('.option-row').remove();
    optionCount--;
    updateAddButton();
    updateRemoveButtons();
}

function updateAddButton() {
    const addBtn = document.getElementById('addOptionBtn');
    addBtn.disabled = optionCount >= maxOptions;
}

function updateRemoveButtons() {
    const removeButtons = document.querySelectorAll('.remove-option');
    removeButtons.forEach((btn, index) => {
        btn.disabled = optionCount <= 2;
    });
}

function resetForm() {
    document.getElementById('addConditionForm').reset();
    const container = document.getElementById('optionsContainer');
    container.innerHTML = `
        <div class="flex gap-2 items-center option-row">
            <input type="text" class="input input-bordered flex-1 option-label" placeholder="Option Label (e.g., Excellent)" required>
            <input type="number" class="input input-bordered w-24 option-percentage" placeholder="%" step="0.1" min="0" max="50" value="0" required>
            <button type="button" class="btn btn-ghost btn-sm remove-option" onclick="removeOption(this)" disabled>
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="flex gap-2 items-center option-row">
            <input type="text" class="input input-bordered flex-1 option-label" placeholder="Option Label (e.g., Good)" required>
            <input type="number" class="input input-bordered w-24 option-percentage" placeholder="%" step="0.1" min="0" max="50" value="5" required>
            <button type="button" class="btn btn-ghost btn-sm remove-option" onclick="removeOption(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    optionCount = 2;
    updateAddButton();
    updateRemoveButtons();
}

// Form submission
document.getElementById('addConditionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('conditionName').value;
    const options = [];
    
    document.querySelectorAll('.option-row').forEach(row => {
        const label = row.querySelector('.option-label').value;
        const percentage = parseFloat(row.querySelector('.option-percentage').value);
        if (label && !isNaN(percentage)) {
            options.push({ label, percentage });
        }
    });
    
    if (options.length < 2) {
        Swal.fire('Invalid Options', 'At least 2 options are required.', 'error');
        return;
    }
    
    // Send AJAX request to save condition
    fetch('{% url "main:condition_add" config.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name, options })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Success!', data.message, 'success').then(() => {
                location.reload(); // Reload to show new condition
            });
        } else {
            Swal.fire('Error!', data.error, 'error');
        }
    })
    .catch(error => {
        Swal.fire('Error!', 'Failed to add condition: ' + error.message, 'error');
    });
});

function editCondition(conditionId) {
    // Get condition data
    fetch('{% url "main:condition_edit" config.id 999 %}'.replace('999', conditionId), {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const condition = data.condition;
            
            // Populate edit form
            document.getElementById('editConditionId').value = condition.id;
            document.getElementById('editConditionName').value = condition.name;
            
            // Clear and populate options
            const container = document.getElementById('editOptionsContainer');
            container.innerHTML = '';
            
            condition.options.forEach(option => {
                addEditOptionRow(option.label, option.percentage);
            });
            
            // Show modal
            document.getElementById('editModal').classList.add('modal-open');
        } else {
            Swal.fire('Error!', 'Failed to load condition data', 'error');
        }
    })
    .catch(error => {
        Swal.fire('Error!', 'Failed to load condition: ' + error.message, 'error');
    });
}

function deleteCondition(conditionId) {
    Swal.fire({
        title: 'Delete Condition?',
        text: 'This will permanently remove the condition and all its options.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Delete',
        confirmButtonColor: '#ef4444'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('{% url "main:condition_delete" config.id 999 %}'.replace('999', conditionId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Deleted!', data.message, 'success').then(() => {
                        location.reload(); // Reload to hide deleted condition
                    });
                } else {
                    Swal.fire('Error!', data.error, 'error');
                }
            })
            .catch(error => {
                Swal.fire('Error!', 'Failed to delete condition: ' + error.message, 'error');
            });
        }
    });
}

// Edit form submission
document.getElementById('editConditionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const conditionId = document.getElementById('editConditionId').value;
    const name = document.getElementById('editConditionName').value;
    const options = [];
    
    document.querySelectorAll('#editOptionsContainer .edit-option-row').forEach(row => {
        const label = row.querySelector('.edit-option-label').value;
        const percentage = parseFloat(row.querySelector('.edit-option-percentage').value);
        if (label && !isNaN(percentage)) {
            options.push({ label, percentage });
        }
    });
    
    if (options.length < 2) {
        Swal.fire('Invalid Options', 'At least 2 options are required.', 'error');
        return;
    }
    
    fetch('{% url "main:condition_edit" config.id 999 %}'.replace('999', conditionId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name, options })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Success!', data.message, 'success').then(() => {
                closeEditModal();
                location.reload();
            });
        } else {
            Swal.fire('Error!', data.error, 'error');
        }
    })
    .catch(error => {
        Swal.fire('Error!', 'Failed to update condition: ' + error.message, 'error');
    });
});

function addEditOption() {
    addEditOptionRow('', 5);
}

function addEditOptionRow(label = '', percentage = 5) {
    const container = document.getElementById('editOptionsContainer');
    const optionRow = document.createElement('div');
    optionRow.className = 'flex gap-2 items-center edit-option-row';
    optionRow.innerHTML = `
        <input type="text" class="input input-bordered flex-1 edit-option-label" placeholder="Option Label" value="${label}" required>
        <input type="number" class="input input-bordered w-24 edit-option-percentage" placeholder="%" step="0.1" min="0" max="50" value="${percentage}" required>
        <button type="button" class="btn btn-ghost btn-sm remove-edit-option" onclick="removeEditOption(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(optionRow);
}

function removeEditOption(button) {
    const rows = document.querySelectorAll('#editOptionsContainer .edit-option-row');
    if (rows.length > 2) {
        button.closest('.edit-option-row').remove();
    } else {
        Swal.fire('Cannot Remove', 'At least 2 options are required.', 'warning');
    }
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('modal-open');
}

// Initialize
updateRemoveButtons();
</script>
{% endblock %}